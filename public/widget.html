<html>
<head>
 <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"></link>
 <link rel="stylesheet" type="text/css" href="css/widget_style.css">
 <script src='//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js'/></script>
 <script src="/socket.io/socket.io.js"></script>
 <script>
  function sendMessage(socket, commandstring, meta) {
    socket.emit('send', {message: commandstring, content: meta });
  }	
	
  window.onload = function() {
  var messages = [];
  var hostname = 'http://'+document.location.hostname+':1337';
  var socket = io.connect(hostname);

  //*----- LINKS -----*//
  
  $('#showlinks').click(function() { sendMessage(socket, 'showlinks', ''); });
  $('#hidelinks').click(function() { sendMessage(socket, 'hidelinks', ''); });
  $('#pulselinks10').click(function() { sendMessage(socket, 'pulselinks', '10'); });
  $('#pulselinks30').click(function() { sendMessage(socket, 'pulselinks', '30'); });
  $('#pulselinks60').click(function() { sendMessage(socket, 'pulselinks', '60'); });
        
  //*----- ALERT -----*//

  $('#sendalert').click(function() { sendMessage(socket, 'showalert', $('#alertmessage').val()); });
		
  //*----- Lo3rd -----*//  
  
  $('#showlowerthird').click(function() { prepLowerThird(0); });
  $('#hidelowerthird').click(function() { sendMessage(socket, 'hidelowerthird', ''); });
  $('#pulselowerthird10').click(function() { prepLowerThird(10); });
  $('#pulselowerthird30').click(function() { prepLowerThird(30); });
  $('#pulselowerthird60').click(function() { prepLowerThird(60); });
  
  function prepLowerThird(number) {
    var lowerthird = {'title': $('#lowerthirdtitle').val(), 'text': $('#lowerthirdtext').val(), 'duration': number};
    var lowerthirdJSON = JSON.stringify(lowerthird);
    
    if (number > 0)
      sendMessage(socket, 'pulselowerthird', lowerthirdJSON);
    else
      sendMessage(socket, 'showlowerthird', lowerthirdJSON);
  }
		
  //*----- SCENE -----*//
  
  $('#scenebutton').click(function() { prepSceneChange($('#scenename').val(), true); });
  $('#scenedropbutton').click(function() { prepSceneChange(sceneName.value); });
  $('#dropshutters').click(function() { sendMessage(socket, 'dropshutters', ''); });
  $('#raiseshutters').click(function() { sendMessage(socket, 'raiseshutters', ''); });
  
  var obsRemoteURL = 'ws://localhost:4444';
  var sceneSocket = new WebSocket(obsRemoteURL, "obsapi");
  
  function checkOBSSocket() {
    //re-open the socket if it is "CLOSED" (3) or "CLOSING" (2)
    if (sceneSocket.readyState == 2 || sceneSocket.readyState == 3) {
      sceneSocket = new WebSocket(obsRemoteURL, "obsapi");
      console.log("[SCENE] re-opening OBS socket");
      return true;
    }
    
    return false;
  }
  
  function prepSceneChange(msg, autoraise) {
      if (checkOBSSocket() == true) {
        //the socket wasn't connected, so let's give it time to open
        setTimeout(function(){
          sceneSocket.send(obsJSON);
        }, 200);
      } else {
        //socket is already open, do the work immediately
        doWork();
      }
      
      function doWork() {
        //set up json request for obs scene change             
        var obs = {"request-type": "SetCurrentScene", "scene-name": msg, "message-id": 1};
        var obsJSON = JSON.stringify(obs);        
        
        if (autoraise) {
          //trigger transition anim in index.html
          sendMessage(socket, 'transition', '');
        } else {
          //just drop the shutters, we'll handle raising them manually
          sendMessage(socket, 'dropshutters', '');
        }

        //trigger scene change in obs
        setTimeout(function(){
          sceneSocket.send(obsJSON);
        }, 1000);        
      }      
    }	
		
		//*----- STATS & BRACKET -----*//
    
    $('#showstatsbutton').click(function() { sendMessage(socket, 'showstats', $('#statsid').val()); });
    $('#showbracketbutton').click(function() { sendMessage(socket,'showbracket', $('#bracketid').val()); });
    
    
    //*----- SCOREBOARD -----*//
    
    $('#updatescores').click(function() { prepUpdateScores(); });
    $('#swapteamcolors').click(function() { sendMessage(socket, 'swapteamcolors'); });
   
    function prepUpdateScores() {
      var mapNum = $("input:radio[name=map]:checked").val();
      var mapNames = {
          "map1": $('#scoreboard > div.table > div:nth-child(2) > div:nth-child(1) > input').val(),
          "map2": $('#scoreboard > div.table > div:nth-child(3) > div:nth-child(1) > input').val(),
          "map3": $('#scoreboard > div.table > div:nth-child(4) > div:nth-child(1) > input').val()
      };
      var mapScores = {
        "map1": 
          {
            "team1": $('#scoreboard > div.table > div:nth-child(2) > div:nth-child(2) > input').val(),
            "team2": $('#scoreboard > div.table > div:nth-child(2) > div:nth-child(3) > input').val()
          },
        "map2": 
          {
            "team1": $('#scoreboard > div.table > div:nth-child(3) > div:nth-child(2) > input').val(),
            "team2": $('#scoreboard > div.table > div:nth-child(3) > div:nth-child(3) > input').val()
          },
        "map3": 
          {
            "team1": $('#scoreboard > div.table > div:nth-child(4) > div:nth-child(2) > input').val(),
            "team2": $('#scoreboard > div.table > div:nth-child(4) > div:nth-child(3) > input').val()
          }
      };                            
      var teamNames = {
        "team1": $('#team1name').val(),
        "team2": $('#team2name').val()
      };
                      
      var mapNamesJSON = JSON.stringify(mapNames);
      var mapScoresJSON = JSON.stringify(mapScores);
      var teamNamesJSON = JSON.stringify(teamNames);
      
      var sbData = {
        "mapNum": mapNum, 
        "mapNames": mapNames, 
        "mapScores": mapScores, 
        "teamNames": teamNames
      };  
      
      sendMessage(socket, 'updatescore', JSON.stringify(sbData));
    }  

    //*----- ROSTERS -----*//
    var rosterSize = $("input:radio[name=rostersize]:checked").val();
    $("input:radio[name=rostersize]").change(function() {
        changeRosterSize();
    });
    
    function changeRosterSize() {
      rosterSize = $("input:radio[name=rostersize]:checked").val();
      var content = '<div class="rosterrow row">' +
                    '<div class="cell redteam"><input></div>' +
                    '<div class="classicon"></div>' +
                    '<div class="cell bluteam"><input></div></div>';
      
      for (var i = 0; i < rosterSize; i++) {
        content += '<div class="rosterrow row">' +
                   '<div class="cell"><input></div>' +
                   '<div class="classicon"></div>' +
                   '<div class="cell"><input></div></div>';
        $('#rosters > div.table').html(content);
      }
      
      //add class icons
      if (rosterSize == 6) {
        //scouts
        $('#rostertable > div:nth-child(2) > div:nth-child(2)').css('background-position-y',-16*1);
        $('#rostertable > div:nth-child(3) > div:nth-child(2)').css('background-position-y',-16*1);
        //soldiers
        $('#rostertable > div:nth-child(4) > div:nth-child(2)').css('background-position-y',-16*2);
        $('#rostertable > div:nth-child(5) > div:nth-child(2)').css('background-position-y',-16*2);
        //demo
        $('#rostertable > div:nth-child(6) > div:nth-child(2)').css('background-position-y',-16*4);
        //medic
        $('#rostertable > div:nth-child(7) > div:nth-child(2)').css('background-position-y',-16*7);
      } else {
        for (var i = 1; i <= rosterSize+1; i++) {
          $('#rostertable > div:nth-child('+i+') > div:nth-child(2)').css('background-position-y',-16*(i-1));
        }  
      }
    }
        
    //initalize
    changeRosterSize();
    
    $('#showrosters').click(function() { prepRosters(); });
    $('#hiderosters').click(function() { sendMessage(socket, 'hiderosters', $("input:radio[name=rostersize]:checked").val()); });
    $('#swaprosters').click(function() { swapRosters(); });
      
    function prepRosters() {
      var redRoster = {};
      var bluRoster = {};
      var teamNames = { 'red': $('#rostertable > div:nth-child(1) > div.cell.redteam > input').val()
                      , 'blu': $('#rostertable > div:nth-child(1) > div.cell.bluteam > input').val() };
      
      //start at 2 to compensate for table header row
      for (var i = 2; i < rosterSize+2; i++) {
          redRoster[i-2] = $('#rostertable > div:nth-child('+i+') > div:nth-child(1) > input').val();
          bluRoster[i-2] = $('#rostertable > div:nth-child('+i+') > div:nth-child(3) > input').val();
      }
      
      var rosterJSON = JSON.stringify({'redRoster': redRoster, 'bluRoster': bluRoster, 'teamNames': teamNames});
      sendMessage(socket, 'showrosters', rosterJSON);
    }
      
    function swapRosters() {            
      for (var i = 1; i < rosterSize+2; i++) {
        var temp;
        temp = $('#rostertable > div:nth-child('+i+') > div:nth-child(1) > input').val();
        $('#rostertable > div:nth-child('+i+') > div:nth-child(1) > input').val($('#rostertable > div:nth-child('+i+') > div:nth-child(3) > input').val());
        $('#rostertable > div:nth-child('+i+') > div:nth-child(3) > input').val(temp);
      }
    }
  }    
 </script>
</head>
<body>
<div id="container">
    <div class="panel">
        <span class="heading">Social Media:</span>
        <div class="triplet"><div class="row">            
            <div class="button"><button type="button" id="showlinks">Show</button></div>
            <div class="button"><button type="button" id="pulselinks10">10s</button></div>
            <div class="button"><button type="button" id="pulselinks30">30s</button></div>
            <div class="button"> <button type="button" id="pulselinks60">60s</button></div>
        </div></div>
        <button type="button" id="hidelinks" class="hidebutton">Hide social media links</button><br />
    </div>
    
    <div class="panel">
        <span class="heading">Alert Msg:</span>
        <input type="field" id="alertmessage" style="width:100%" />
        <button type="button" id="sendalert">Send alert</button>
    </div>
    
    <div class="panel">
        <span class="heading">Scene name:</span>
        <input type="field" id="scenename" style="width:100%" />
        <button type="button"id="scenebutton">Change scene (auto drop/raise)</button>
        <button type="button"id="scenedropbutton">Change scene (drop only)</button>
        <div class="triplet"><div class="row"> 
            <div class="button"><button type="button" id="dropshutters">Drop Shutters</button></div>
            <div class="button"><button type="button" id="raiseshutters" class="hidebutton">Raise Shutters</button></div>
        </div></div>
    </div>
    
    <div class="panel">
        <span class="heading">SizzlingStats ID:</span>
        <input type="field" id="statsid" style="width:100%" />
        <button type="button" id="showstatsbutton">Update stats</button>
    </div>
    
    <div class="panel">
        <span class="heading">Challonge Bracket ID:</span>
        <input type="field" id="bracketid" style="width:100%" />
        <button type="button" id="showbracketbutton">Update bracket</button>
    </div>
    
    <div class="panel">
        <span class="heading">Lowerthird Title:</span>
        <input type="field" id="lowerthirdtitle" style="width:100%" />
        <span class="heading">Lowerthird Text:</span>
        <input type="field" id="lowerthirdtext" style="width:100%" />
        <div class="triplet"><div class="row"> 
            <div class="button"><button type="button" id="showlowerthird">Show</button></div>
            <div class="button"><button type="button" id="pulselowerthird10">10s</button></div>
            <div class="button"><button type="button" id="pulselowerthird30">30s</button></div>
            <div class="button"><button type="button" id="pulselowerthird60">60s</button></div>
        </div></div>
        <button type="button" id="hidelowerthird" class="hidebutton">Hide lowerthird</button>        
    </div>
    
    <div class="panel" id="scoreboard">
        <span class="heading">Scoreboard:</span>
        <div class="triplet"><div class="row">
            <div class="button">
                <div class="subheading">Team 1 Name</div>
                <input type="field" id="team1name" style="width:100%" />
            </div>
            <div class="button">
                <div class="subheading">Team 2 Name</div>
                <input type="field" id="team2name" style="width:100%" />
            </div>
        </div></div>
        <div class="triplet"><div class="row"> 
            <div class="button"><input type="radio" name="map" value="1" checked="checked">Map 1</div>
            <div class="button"><input type="radio" name="map" value="2">Map 2</div>
            <div class="button"><input type="radio" name="map" value="3">Map 3</div>
        </div></div>
        <div class="subheading">Maps</div>
        <div class="table">
            <div class="titlerow row" id="titlerow0">
            <div class="rowtitle cell">Round 1</div>
            <div class="rowtitle team1 cell red">Team 1</div>
            <div class="rowtitle team2 cell blue">Team 2</div>
            </div>
            <div class="row maprow">
                <div class="cell">
                    <div class="currentmap selected">
                        <i class="fa fa-chevron-right"></i>
                    </div>
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
            </div>
            <div class="row maprow">
                <div class="cell">
                    <div class="currentmap selected">
                        <i class="fa fa-chevron-right"></i>
                    </div>
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
            </div>
            <div class="row maprow">
                <div class="cell">
                    <div class="currentmap selected">
                        <i class="fa fa-chevron-right"></i>
                    </div>
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
                <div class="cell">
                    <input>
                </div>
            </div>
        </div>
        <button type="button" id="updatescores">Update scoreboard</button>
        <button type="button" id="swapteamcolors">Swap team colors</button>
    </div>
    
    <div class="panel" id="rosters">
        <span class="heading">Roster Rundowns:</span>
        <div class="triplet"><div class="row"> 
            <div class="button"><input type="radio" name="rostersize" value="6" checked="checked">6v6</div>
            <div class="button"><input type="radio" name="rostersize" value="9">9v9</div>
        </div></div>
        <div class="table" id="rostertable"></div>
        <button type="button" id="swaprosters">Swap rosters</button>
        <button type="button" id="showrosters">Show rosters</button>
        <button type="button" id="hiderosters" class="hidebutton">Hide rosters</button>
    </div>
</div>
</body>
</html>
